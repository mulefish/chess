<!DOCTYPE html>
<html lang="en">

<head>
    <!-- <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css" rel="stylesheet"> -->
    <script src="version3.js"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Version 3</title>
    <style>
        .cell {
            width: 50px;
            height: 50px;
            font-size: 40px;
            text-align: center;
            user-select: none;
            /* Prevent text selection */

        }

        .cream {
            background-color: #fff3f3;
        }

        .green {
            background-color: lightgreen;
        }

        .highlight {
            background-color: yellow;
            width: 49px;
            height: 49px;
            border: 1px solid #e0e0e0;
        }

        .highlightAttack {
            background-color: pink;
            width: 49px;
            height: 49px;
            border: 1px solid #e0e0e0;
        }
    </style>
</head>

<body>
    <div id="activeCell">&nbsp;</div>
    <table border="1">
        <tr>
            <td class="cell cream" id="0-0" data-piece="" data-row="0" data-col="0"></td>
            <td class="cell green" id="0-1" data-piece="" data-row="0" data-col="1"></td>
            <td class="cell cream" id="0-2" data-piece="" data-row="0" data-col="2"></td>
            <td class="cell green" id="0-3" data-piece="" data-row="0" data-col="3"></td>
            <td class="cell cream" id="0-4" data-piece="" data-row="0" data-col="4"></td>
            <td class="cell green" id="0-5" data-piece="" data-row="0" data-col="5"></td>
            <td class="cell cream" id="0-6" data-piece="" data-row="0" data-col="6"></td>
            <td class="cell green" id="0-7" data-piece="" data-row="0" data-col="7"></td>
        </tr>
        <tr>
            <td class="cell green" id="1-0" data-piece="" data-row="1" data-col="0"></td>
            <td class="cell cream" id="1-1" data-piece="" data-row="1" data-col="1"></td>
            <td class="cell green" id="1-2" data-piece="" data-row="1" data-col="2"></td>
            <td class="cell cream" id="1-3" data-piece="" data-row="1" data-col="3"></td>
            <td class="cell green" id="1-4" data-piece="" data-row="1" data-col="4"></td>
            <td class="cell cream" id="1-5" data-piece="" data-row="1" data-col="5"></td>
            <td class="cell green" id="1-6" data-piece="" data-row="1" data-col="6"></td>
            <td class="cell cream" id="1-7" data-piece="" data-row="1" data-col="7"></td>
        </tr>
        <tr>
            <td class="cell cream" id="2-0" data-piece="" data-row="2" data-col="0"></td>
            <td class="cell green" id="2-1" data-piece="" data-row="2" data-col="1"></td>
            <td class="cell cream" id="2-2" data-piece="" data-row="2" data-col="2"></td>
            <td class="cell green" id="2-3" data-piece="" data-row="2" data-col="3"></td>
            <td class="cell cream" id="2-4" data-piece="" data-row="2" data-col="4"></td>
            <td class="cell green" id="2-5" data-piece="" data-row="2" data-col="5"></td>
            <td class="cell cream" id="2-6" data-piece="" data-row="2" data-col="6"></td>
            <td class="cell green" id="2-7" data-piece="" data-row="2" data-col="7"></td>
        </tr>
        <tr>
            <td class="cell green" id="3-0" data-piece="" data-row="3" data-col="0"></td>
            <td class="cell cream" id="3-1" data-piece="" data-row="3" data-col="1"></td>
            <td class="cell green" id="3-2" data-piece="" data-row="3" data-col="2"></td>
            <td class="cell cream" id="3-3" data-piece="" data-row="3" data-col="3"></td>
            <td class="cell green" id="3-4" data-piece="" data-row="3" data-col="4"></td>
            <td class="cell cream" id="3-5" data-piece="" data-row="3" data-col="5"></td>
            <td class="cell green" id="3-6" data-piece="" data-row="3" data-col="6"></td>
            <td class="cell cream" id="3-7" data-piece="" data-row="3" data-col="7"></td>
        </tr>
        <tr>
            <td class="cell cream" id="4-0" data-piece="" data-row="4" data-col="0"></td>
            <td class="cell green" id="4-1" data-piece="" data-row="4" data-col="1"></td>
            <td class="cell cream" id="4-2" data-piece="" data-row="4" data-col="2"></td>
            <td class="cell green" id="4-3" data-piece="" data-row="4" data-col="3"></td>
            <td class="cell cream" id="4-4" data-piece="" data-row="4" data-col="4"></td>
            <td class="cell green" id="4-5" data-piece="" data-row="4" data-col="5"></td>
            <td class="cell cream" id="4-6" data-piece="" data-row="4" data-col="6"></td>
            <td class="cell green" id="4-7" data-piece="" data-row="4" data-col="7"></td>
        </tr>
        <tr>
            <td class="cell green" id="5-0" data-piece="" data-row="5" data-col="0"></td>
            <td class="cell cream" id="5-1" data-piece="" data-row="5" data-col="1"></td>
            <td class="cell green" id="5-2" data-piece="" data-row="5" data-col="2"></td>
            <td class="cell cream" id="5-3" data-piece="" data-row="5" data-col="3"></td>
            <td class="cell green" id="5-4" data-piece="" data-row="5" data-col="4"></td>
            <td class="cell cream" id="5-5" data-piece="" data-row="5" data-col="5"></td>
            <td class="cell green" id="5-6" data-piece="" data-row="5" data-col="6"></td>
            <td class="cell cream" id="5-7" data-piece="" data-row="5" data-col="7"></td>
        </tr>
        <tr>
            <td class="cell cream" id="6-0" data-piece="" data-row="6" data-col="0"></td>
            <td class="cell green" id="6-1" data-piece="" data-row="6" data-col="1"></td>
            <td class="cell cream" id="6-2" data-piece="" data-row="6" data-col="2"></td>
            <td class="cell green" id="6-3" data-piece="" data-row="6" data-col="3"></td>
            <td class="cell cream" id="6-4" data-piece="" data-row="6" data-col="4"></td>
            <td class="cell green" id="6-5" data-piece="" data-row="6" data-col="5"></td>
            <td class="cell cream" id="6-6" data-piece="" data-row="6" data-col="6"></td>
            <td class="cell green" id="6-7" data-piece="" data-row="6" data-col="7"></td>
        </tr>
        <tr>
            <td class="cell green" id="7-0" data-piece="" data-row="7" data-col="0"></td>
            <td class="cell cream" id="7-1" data-piece="" data-row="7" data-col="1"></td>
            <td class="cell green" id="7-2" data-piece="" data-row="7" data-col="2"></td>
            <td class="cell cream" id="7-3" data-piece="" data-row="7" data-col="3"></td>
            <td class="cell green" id="7-4" data-piece="" data-row="7" data-col="4"></td>
            <td class="cell cream" id="7-5" data-piece="" data-row="7" data-col="5"></td>
            <td class="cell green" id="7-6" data-piece="" data-row="7" data-col="6"></td>
            <td class="cell cream" id="7-7" data-piece="" data-row="7" data-col="7"></td>
        </tr>
    </table>

    <script>


        let pieces = {};
        let activeCell = undefined;
        let activePiece = undefined;
        let possibleMoves = undefined;
        let possibleAttacks = undefined;
        let highlighted = [];
        let highlightedAttacks = [];
        const white = "white"
        const black = "black"


        function handleCellClick(event) {
            if (event.target.tagName === 'TD' && event.target.classList.contains('cell')) {
                const row = event.target.getAttribute('data-row');
                const col = event.target.getAttribute('data-col');
                activeCell = event.target.getAttribute('id');



                if (highlightedAttacks.includes(activeCell)) {
                    const attackedPiece = event.target.getAttribute('data-piece');


                    placeAttackingPiece(row, col, activePiece, attackedPiece)
                } else {
                    if (highlighted.includes(activeCell) && activePiece !== undefined && activePiece.length > 1) {
                        placingPiece(row, col);
                    } else {
                        selectingPiece();
                    }
                }
            }
        }

        document.querySelector('table').addEventListener('click', handleCellClick);

        function placingPiece(row, col) {
            // Move the piece
            pieces[activePiece].removeFromPlace();
            const newLocation = `${row}-${col}`;
            pieces[activePiece].placePiece(newLocation);

            // Reset active state and clear highlights
            activePiece = undefined;
            removeHighlightFromCells(highlighted);
            removeHighlightAttackFromCells(highlightedAttacks);

            highlighted = [];
            highlightedAttacks = [];
        }

        function placeAttackingPiece(row, col, attackingPieceKey, attackedPieceKey) {
            // Identify the fromCell and toCell
            const fromCell = pieces[attackingPieceKey].cellId;
            const toCell = `${row}-${col}`; // Target cell determined from row and col

            // Remove the attacked piece from the toCell
            const attackedCell = document.getElementById(toCell);
            if (attackedCell) {
                attackedCell.innerHTML = ""; // Clear the target cell
                attackedCell.removeAttribute('data-piece'); // Remove data-piece attribute
                if (attackedPieceKey) {
                    console.log(`Removing attacked piece "${attackedPieceKey}" from "${toCell}"`);

                    delete pieces[attackedPieceKey]; // Remove the attacked piece from the pieces object
                }
                console.log(`Highlights cleared. Ready for next action.`);
            } else {
                console.warn(`Target cell "${toCell}" not found.`);
            }

            // Remove the attacking piece from the fromCell
            const attackingCell = document.getElementById(fromCell);
            if (attackingCell) {
                attackingCell.innerHTML = ""; // Clear the current cell
                attackingCell.removeAttribute('data-piece'); // Remove data-piece attribute
            } else {
                console.warn(`From cell "${fromCell}" not found.`);
            }

            // Place the attacking piece in the toCell
            pieces[attackingPieceKey].placePiece(toCell);

            // Reset active state and clear highlights
            activePiece = undefined;
            removeHighlightFromCells(highlighted);
            removeHighlightAttackFromCells(highlightedAttacks);

            highlighted = [];
            highlightedAttacks = [];
        }


        function selectingPiece() {
            activePiece = event.target.getAttribute('data-piece');
            if (activePiece !== undefined && activePiece.length > 1) {
                document.getElementById("activeCell").innerHTML =
                    "activeCell=" + activeCell + " activePiece=" + activePiece;

                // Clear previous highlights
                removeHighlightFromCells(highlighted);
                removeHighlightAttackFromCells(highlightedAttacks);

                highlighted = [];
                highlightedAttacks = [];

                // Highlight moves and attacks
                possibleMoves = pieces[activePiece].getReachableCells();
                possibleAttacks = pieces[activePiece].getAttackableCells();
                highlightCells(possibleMoves);
                highlightAttackableCells(possibleAttacks);
            } else {
                document.getElementById("activeCell").innerHTML = "activeCell=" + activeCell;
            }
        }

        function removeHighlightFromCells(cellIds, highlightClass = "highlight") {
            cellIds.forEach(cellId => {
                const cell = document.getElementById(cellId);
                if (cell) {
                    cell.classList.remove(highlightClass);
                } else {
                    console.warn(`Cell with ID "${cellId}" not found.`);
                }
            });
        }

        function removeHighlightAttackFromCells(cellIds, highlightClass = "highlightAttack") {
            cellIds.forEach(cellId => {
                const cell = document.getElementById(cellId);
                if (cell) {
                    cell.classList.remove(highlightClass);
                } else {
                    console.warn(`Cell with ID "${cellId}" not found.`);
                }
            });
        }

        function highlightCells(cellIds, highlightClass = "highlight") {
            cellIds.forEach(cellId => {
                const cell = document.getElementById(cellId);
                if (cell) {
                    cell.classList.add(highlightClass);
                    if (!highlighted.includes(cellId)) {
                        highlighted.push(cellId);
                    }
                } else {
                    console.warn(`Cell with ID "${cellId}" not found.`);
                }
            });
        }

        function highlightAttackableCells(cellIds, highlightClass = "highlightAttack") {
            cellIds.forEach(cellId => {
                const cell = document.getElementById(cellId);
                if (cell) {
                    cell.classList.add(highlightClass);
                    if (!highlightedAttacks.includes(cellId)) {
                        highlightedAttacks.push(cellId);
                    }
                } else {
                    console.warn(`Cell with ID "${cellId}" not found.`);
                }
            });
        }



        new Piece("br1", 0, 0, "♜", black, "rook", 8);
        new Piece("bn1", 0, 1, "♞", black, "knight", 1);
        new Piece("bb1", 0, 2, "♝", black, "bishop", 8);
        new Piece("bq", 0, 3, "♛", black, "queen", 8);
        new Piece("bk", 0, 4, "♚", black, "king", 1);
        new Piece("bb2", 0, 5, "♝", black, "bishop", 8);
        new Piece("bn2", 0, 6, "♞", black, "knight", 1);
        new Piece("br2", 0, 7, "♜", black, "rook", 8);
        new Piece("bpawn1", 5, 5, "♟", black, "pawnb", 2);
        new Piece("bpawn2", 5, 6, "♟", black, "pawnb", 2);
        new Piece("bpawn3", 5, 7, "♟", black, "pawnb", 2);
        new Piece("bpawn4", 5, 4, "♟", black, "pawnb", 2);
        new Piece("bpawn5", 5, 3, "♟", black, "pawnb", 2);
        new Piece("bpawn6", 1, 2, "♟", black, "pawnb", 2);
        new Piece("bpawn7", 1, 1, "♟", black, "pawnb", 2);


        new Piece("wr1", 7, 0, "♖", white, "rook", 8);
        new Piece("wn1", 7, 1, "♘", white, "knight", 1);
        new Piece("wb1", 7, 2, "♗", white, "bishop", 8);
        new Piece("wq", 7, 3, "♕", white, "queen", 8);
        new Piece("wk", 7, 4, "♔", white, "king", 1);
        new Piece("wb2", 7, 5, "♗", white, "bishop", 8);
        new Piece("wn2", 7, 6, "♘", white, "knight", 1);
        new Piece("wr2", 7, 7, "♖", white, "rook", 8);
        new Piece("wpawn1", 6, 0, "♙", white, "pawnw", 2);
        new Piece("wpawn2", 6, 1, "♙", white, "pawnw", 2);
        new Piece("wpawn3", 6, 2, "♙", white, "pawnw", 2);
        new Piece("wpawn4", 6, 3, "♙", white, "pawnw", 2);
        new Piece("wpawn5", 6, 4, "♙", white, "pawnw", 2);
        new Piece("wpawn6", 6, 5, "♙", white, "pawnw", 2);
        new Piece("wpawn7", 6, 6, "♙", white, "pawnw", 2);
        new Piece("wpawn7", 6, 7, "♙", white, "pawnw", 2);

        function poke() {
            // alert("piece=" + activePiece + "\ncell=" + activeCell);
            console.log("\n\n++++++++++++++++\n")
        }
    </script>
    <button onclick="poke()">poke</button>
</body>

</html>